# Omni Token Wallet - MetaWallet Contract

## Overview

The `MetaWallet` is a smart contract designed for managing token and Ether transactions on the Ethereum blockchain. It supports deposits, withdrawals, and the management of various tokens, including ERC20 tokens and Ether. The contract uses signature verification for secure withdrawal operations, and it has built-in mechanisms for fee handling and contract ownership management.

This contract was audited by Hacken on **24/09/2024**.

### Key Functionalities

### 1. **Ownership and Access Control**
   - **Owner**: The contract has an owner who can perform privileged operations such as withdrawing tokens or Ether, changing key addresses, and closing the contract.
   - **Owner-only Functions**:
     - `withdrawToken()`: Withdraws ERC20 tokens.
     - `withdrawEth()`: Withdraws Ether.
     - `withdrawFees()`: Withdraws accumulated fees.
     - `changeOwner()`: Changes contract ownership.
     - `close()`: Closes the contract by setting the maximum timestamp to prevent further operations.

### 2. **Deposits**
   - **deposit()**: Users can deposit tokens or Ether into the contract on behalf of a receiver. Each deposit is logged with a unique nonce and associated message hash.
     - Tokens (ERC20) or Ether can be deposited.
     - The contract records deposits using the `NewTransfer` event and keeps track of the deposit data using a nonce and message hash.
     - Fees are accumulated when Ether is deposited along with tokens.

### 3. **Withdrawals**
   - **withdrawToken()**: Allows the owner to withdraw ERC20 tokens from the contract.
   - **withdrawEth()**: Allows the owner to withdraw Ether.
   - **withdrawFees()**: Allows the owner to withdraw accumulated fees.
   - **withdraw()**: Allows withdrawal of tokens or Ether to a receiver based on a signed message. This function validates the signature to ensure that the withdrawal is authorized.
     - The signature verification prevents unauthorized withdrawals.
     - It ensures that the nonce is valid and unused before executing the transaction.

### 4. **Signature Verification**
   - The contract verifies signatures using the **ECDSA** library to ensure that withdrawals are authorized. The signature must be generated by the `verifyAddress`.
   - **verify()**: This internal function verifies the signature of a message that includes details like nonce, contract ID, receiver ID, and amount.

### 5. **Nonce and Timestamp Management**
   - Each operation is linked to a unique **nonce** to prevent replay attacks.
   - **Nonce**: A 128-bit value that ensures each transaction is unique.
   - **Timestamp Management**: The contract enforces time constraints on operations (e.g., minimum and maximum timestamp checks) to ensure timely execution of transactions.
   - The contract handles expired or unused nonces and allows refunds in specific conditions.

### 6. **Events**
   - **NewTransfer(uint128 nonce, uint128 amount, bytes contract_id, bytes receiver)**: This event is emitted whenever a new deposit or transfer is made.

### 7. **Security**
   - **Nonces**: Ensures that each transaction is unique and prevents replay attacks.
   - **Signature Verification**: Protects against unauthorized withdrawals by verifying signatures with the stored `verifyAddress`.
   - **MPC Signature**: The verification key is stored in a secure location and controlled by HOT Protocol validators. Any withdraw request must be initiated by smart contract on NEAR blockchain and approved by HOT Protocol validators.

### 8. **HOT Protocol Api**
   - **Deposits**: To verify deposits, HOT Validators will call `hot_verify()` function on the contract. This function will only return `true` if the deposit hash exists in the contract and associated with the provided nonce.
   - **Refunds**: If withdrawals are not executed within the specified time, the contract will allow refunds. HOT Validators will call `hot_refund()` function to verify deposit with provided nonce was not executed and expired (nonce is older 10min).


## Contract Deployment and Initialization

When deploying the `MetaWallet` contract, you need to provide the following:
1. **_verifyAddress**: The address used to verify signatures. **Address supposed to be controlled by HOT Protocol validators.**
2. **_chainId**: The chain ID of the blockchain where the contract is deployed.

The contract initializes with the owner being the deployer and sets the `minTimestamp` to the deployment time.

## Additional Information

- **Audit Report**: This contract was audited by Hacken. The full audit report can be found [here](https://example.com/audit-report).
